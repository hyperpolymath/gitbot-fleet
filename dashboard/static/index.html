<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f1419;
            color: #c9d1d9;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #1f6feb 0%, #388bfd 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(31, 111, 235, 0.3);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            transition: border-color 0.2s;
        }

        .card:hover {
            border-color: #1f6feb;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #58a6ff;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-healthy { background: #238636; color: #fff; }
        .status-degraded { background: #d29922; color: #fff; }
        .status-unhealthy { background: #f85149; color: #fff; }
        .status-critical { background: #da3633; color: #fff; }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #21262d;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #8b949e;
        }

        .metric-value {
            font-weight: 600;
            color: #c9d1d9;
        }

        .health-score {
            font-size: 3rem;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
        }

        .score-excellent { color: #3fb950; }
        .score-good { color: #58a6ff; }
        .score-fair { color: #d29922; }
        .score-poor { color: #f85149; }

        .bot-list {
            display: grid;
            gap: 10px;
        }

        .bot-item {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bot-name {
            font-weight: 600;
            color: #58a6ff;
        }

        .bot-tier {
            font-size: 0.85rem;
            color: #8b949e;
            margin-left: 8px;
        }

        .bot-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .status-completed { background: #238636; color: #fff; }
        .status-running { background: #1f6feb; color: #fff; }
        .status-failed { background: #f85149; color: #fff; }
        .status-pending { background: #6e7681; color: #fff; }

        .findings-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .finding-item {
            background: #0d1117;
            border-left: 3px solid;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .finding-error { border-left-color: #f85149; }
        .finding-warning { border-left-color: #d29922; }
        .finding-info { border-left-color: #58a6ff; }
        .finding-suggestion { border-left-color: #8b949e; }

        .finding-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .finding-severity {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-error { background: #f85149; color: #fff; }
        .severity-warning { background: #d29922; color: #fff; }
        .severity-info { background: #58a6ff; color: #fff; }

        .finding-message {
            color: #c9d1d9;
            margin-bottom: 6px;
        }

        .finding-meta {
            font-size: 0.85rem;
            color: #8b949e;
        }

        .alert-list {
            display: grid;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            background: #0d1117;
            border-left: 4px solid;
            padding: 12px;
            border-radius: 4px;
        }

        .alert-critical { border-left-color: #da3633; }
        .alert-error { border-left-color: #f85149; }
        .alert-warning { border-left-color: #d29922; }
        .alert-info { border-left-color: #58a6ff; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .refresh-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #238636;
            color: #fff;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .refresh-indicator.active {
            opacity: 1;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #3fb950;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ¤– Fleet Dashboard</h1>
            <div class="subtitle">
                <span class="live-indicator"></span>
                Real-time monitoring and control for gitbot-fleet
            </div>
        </header>

        <div id="loading" class="loading">
            <div>Loading fleet data...</div>
        </div>

        <div id="dashboard" style="display: none;">
            <!-- Health Overview -->
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Fleet Health</div>
                        <div id="health-status" class="status-badge">Loading...</div>
                    </div>
                    <div id="health-score" class="health-score">--</div>
                    <div id="health-metrics"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">System Metrics</div>
                    </div>
                    <div id="system-metrics"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Session Info</div>
                    </div>
                    <div id="session-info"></div>
                </div>
            </div>

            <!-- Alerts -->
            <div class="card" style="margin-bottom: 30px;">
                <div class="card-header">
                    <div class="card-title">Active Alerts</div>
                    <div id="alert-count" class="status-badge status-healthy">0</div>
                </div>
                <div id="alerts" class="alert-list">
                    <div style="text-align: center; color: #8b949e; padding: 20px;">No active alerts</div>
                </div>
            </div>

            <!-- Bot Status -->
            <div class="card" style="margin-bottom: 30px;">
                <div class="card-header">
                    <div class="card-title">Bot Status</div>
                </div>
                <div id="bots" class="bot-list"></div>
            </div>

            <!-- Findings -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Recent Findings</div>
                    <div id="findings-count" class="status-badge status-healthy">0</div>
                </div>
                <div id="findings" class="findings-list"></div>
            </div>
        </div>
    </div>

    <div id="refresh-indicator" class="refresh-indicator">Updated</div>

    <script>
        let ws = null;

        // Initialize dashboard
        async function init() {
            await loadDashboard();
            connectWebSocket();
            setInterval(loadDashboard, 10000); // Refresh every 10s
        }

        // Load all dashboard data
        async function loadDashboard() {
            try {
                const [health, status, bots, findings] = await Promise.all([
                    fetch('/api/health').then(r => r.json()),
                    fetch('/api/status').then(r => r.json()),
                    fetch('/api/bots').then(r => r.json()),
                    fetch('/api/findings?limit=50').then(r => r.json()),
                ]);

                renderHealth(health);
                renderSystemMetrics(health.system_metrics);
                renderSessionInfo(status);
                renderAlerts(health.alerts);
                renderBots(bots.bots);
                renderFindings(findings.findings);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

                showRefreshIndicator();
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        // Render health status
        function renderHealth(health) {
            const statusEl = document.getElementById('health-status');
            statusEl.textContent = health.status;
            statusEl.className = `status-badge status-${health.status.toLowerCase()}`;

            const scoreEl = document.getElementById('health-score');
            const score = Math.round(health.health_score);
            scoreEl.textContent = `${score}/100`;

            let scoreClass = 'score-excellent';
            if (score < 85) scoreClass = 'score-good';
            if (score < 70) scoreClass = 'score-fair';
            if (score < 50) scoreClass = 'score-poor';
            scoreEl.className = `health-score ${scoreClass}`;
        }

        // Render system metrics
        function renderSystemMetrics(metrics) {
            const html = `
                <div class="metric">
                    <div class="metric-label">Total Bots</div>
                    <div class="metric-value">${metrics.total_bots}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Completed</div>
                    <div class="metric-value">${metrics.bots_completed}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">In Progress</div>
                    <div class="metric-value">${metrics.bots_in_progress}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Failed</div>
                    <div class="metric-value">${metrics.bots_failed}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Error Rate</div>
                    <div class="metric-value">${(metrics.error_rate * 100).toFixed(1)}%</div>
                </div>
            `;
            document.getElementById('system-metrics').innerHTML = html;
        }

        // Render session info
        function renderSessionInfo(status) {
            const html = `
                <div class="metric">
                    <div class="metric-label">Repository</div>
                    <div class="metric-value">${status.repo_name}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Findings</div>
                    <div class="metric-value">${status.total_findings}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Errors</div>
                    <div class="metric-value">${status.total_errors}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Warnings</div>
                    <div class="metric-value">${status.total_warnings}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Release Status</div>
                    <div class="metric-value">${status.blocks_release ? 'ðŸ”´ Blocked' : 'âœ… Ready'}</div>
                </div>
            `;
            document.getElementById('session-info').innerHTML = html;
        }

        // Render alerts
        function renderAlerts(alerts) {
            const countEl = document.getElementById('alert-count');
            countEl.textContent = alerts.length;
            countEl.className = `status-badge ${alerts.length > 0 ? 'status-unhealthy' : 'status-healthy'}`;

            if (alerts.length === 0) {
                document.getElementById('alerts').innerHTML =
                    '<div style="text-align: center; color: #8b949e; padding: 20px;">No active alerts</div>';
                return;
            }

            const html = alerts.map(alert => `
                <div class="alert-item alert-${alert.severity.toLowerCase()}">
                    <strong>${alert.severity.toUpperCase()}</strong>: ${alert.message}
                    ${alert.bot ? `<br><small>Bot: ${alert.bot}</small>` : ''}
                </div>
            `).join('');

            document.getElementById('alerts').innerHTML = html;
        }

        // Render bots
        function renderBots(bots) {
            const html = bots.map(bot => `
                <div class="bot-item">
                    <div>
                        <span class="bot-name">${bot.id}</span>
                        <span class="bot-tier">(${bot.tier})</span>
                    </div>
                    <div>
                        <span class="bot-status status-${bot.status.toLowerCase()}">${bot.status}</span>
                    </div>
                </div>
            `).join('');
            document.getElementById('bots').innerHTML = html;
        }

        // Render findings
        function renderFindings(findings) {
            const countEl = document.getElementById('findings-count');
            countEl.textContent = findings.length;

            if (findings.length === 0) {
                document.getElementById('findings').innerHTML =
                    '<div style="text-align: center; color: #8b949e; padding: 20px;">No findings</div>';
                return;
            }

            const html = findings.map(f => `
                <div class="finding-item finding-${f.severity.toLowerCase()}">
                    <div class="finding-header">
                        <div>
                            <span class="finding-severity severity-${f.severity.toLowerCase()}">${f.severity}</span>
                            <strong>${f.category}</strong>
                        </div>
                        <span style="color: #8b949e;">${f.source}</span>
                    </div>
                    <div class="finding-message">${f.message}</div>
                    ${f.file ? `<div class="finding-meta">${f.file}${f.line ? `:${f.line}` : ''}</div>` : ''}
                </div>
            `).join('');

            document.getElementById('findings').innerHTML = html;
        }

        // Connect WebSocket for real-time updates
        function connectWebSocket() {
            ws = new WebSocket(`ws://${location.host}/ws`);

            ws.onmessage = (event) => {
                const health = JSON.parse(event.data);
                renderHealth(health);
                renderSystemMetrics(health.system_metrics);
                renderAlerts(health.alerts);
                showRefreshIndicator();
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected, reconnecting...');
                setTimeout(connectWebSocket, 5000);
            };
        }

        // Show refresh indicator
        function showRefreshIndicator() {
            const indicator = document.getElementById('refresh-indicator');
            indicator.classList.add('active');
            setTimeout(() => indicator.classList.remove('active'), 2000);
        }

        // Start dashboard
        init();
    </script>
</body>
</html>
